<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="title">Media Player</title>
    <style>
        /* Responsive CSS */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            font-size: 1.5em;
            margin: 0 0 10px 0;
        }
        video {
            width: 100%;
            max-height: 400px;
            border-radius: 4px;
        }
        .info {
            margin-top: 10px;
            font-size: 0.9em;
        }
        .download-btn {
            display: inline-block;
            margin-top: 10px;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 4px;
        }
        .copy-btn {
            margin-top: 10px;
            padding: 5px 10px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .status {
            margin-top: 10px;
            font-size: 0.8em;
        }
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            h1 {
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="filename">Loading...</h1>
        <video id="video" controls preload="metadata">
            Your browser does not support the video tag.
            <track kind="captions" label="English" aria-describedby="desc">
        </video>
        <div id="info" class="info">
            Size: <span id="size"></span><br>
            Uploader: <span id="uploader"></span><br>
            <a id="download" href="#" class="download-btn">Download</a><br>
            <button id="copy" class="copy-btn">Copy Link</button>
        </div>
        <div id="status" class="status"></div>
        <div id="error" class="error"></div>
    </div>

    <script>
        // Config
        const HLS_ENABLED = false; // Set to true if server supports HLS
        const ANALYTICS_ENABLED = false; // Set to true to enable analytics

        function reportEvent(event, payload = {}) {
            if (!ANALYTICS_ENABLED) return;
            navigator.sendBeacon('/analytics', JSON.stringify({ event, payload }));
        }

        function parseQueryParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                id: urlParams.get('id'),
                name: urlParams.get('name'),
                hash: urlParams.get('hash'),
                player: urlParams.get('player') || 'native'
            };
        }

        const params = parseQueryParams();
        let meta = null;

        function formatSize(bytes) {
            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            let size = bytes;
            let unitIdx = 0;
            while (size >= 1024 && unitIdx < units.length - 1) {
                size /= 1024;
                unitIdx++;
            }
            return `${size.toFixed(1)} ${units[unitIdx]}`;
        }

        async function fetchMeta(retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(`/meta/${params.id}`);
                    if (!response.ok) throw new Error('Meta not found');
                    meta = await response.json();
                    updateUI();
                    return;
                } catch (error) {
                    if (i === retries - 1) {
                        document.getElementById('error').textContent = 'Failed to load metadata. Try refreshing.';
                        reportEvent('meta_fetch_failed', { error: error.message });
                        console.error('Meta fetch error:', error);
                    } else {
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                    }
                }
            }
        }

        function updateUI() {
            document.title = meta.file_name;
            document.getElementById('filename').textContent = meta.file_name;
            document.getElementById('size').textContent = formatSize(meta.file_size);
            document.getElementById('uploader').textContent = meta.uploader_id;

            const streamUrl = `/stream/${params.id}/${encodeURIComponent(params.name)}?hash=${params.hash}`;
            const downloadUrl = `/${params.id}/${encodeURIComponent(params.name)}?hash=${params.hash}`;

            document.getElementById('download').href = downloadUrl;

            // Try poster from /meta/{id}/thumb
            fetch(`/meta/${params.id}/thumb`)
                .then(response => {
                    if (response.ok) {
                        document.getElementById('video').poster = response.url;
                    }
                })
                .catch(() => { /* Ignore, no poster */ });

            const video = document.getElementById('video');
            const source = video.querySelector('source');
            if (!source) {
                const src = document.createElement('source');
                src.src = streamUrl;
                src.type = meta.mime_type || 'video/mp4';
                video.appendChild(src);
            } else {
                source.src = streamUrl;
                source.type = meta.mime_type || 'video/mp4';
            }
            video.load();

            // HLS support
            if (params.player === 'hls' && meta.hls_manifest && HLS_ENABLED) {
                if (!window.Hls) {
                    // Lazy load hls.js
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/hls.js@latest';
                    script.onload = () => {
                        const hls = new Hls();
                        hls.loadSource(meta.hls_manifest);
                        hls.attachMedia(video);
                        hls.on(Hls.Events.ERROR, (event, data) => {
                            document.getElementById('error').textContent = 'HLS load failed, using native player.';
                            reportEvent('hls_failed', data);
                        });
                    };
                    document.head.appendChild(script);
                } else {
                    const hls = new Hls();
                    hls.loadSource(meta.hls_manifest);
                    hls.attachMedia(video);
                }
            }

            // Copy link
            document.getElementById('copy').onclick = async () => {
                const link = window.location.href;
                try {
                    await navigator.clipboard.writeText(link);
                    document.getElementById('status').textContent = 'Link copied!';
                    setTimeout(() => document.getElementById('status').textContent = '', 3000);
                } catch (err) {
                    // Fallback
                    const input = document.createElement('input');
                    input.value = link;
                    document.body.appendChild(input);
                    input.select();
                    document.execCommand('copy');
                    document.body.removeChild(input);
                    document.getElementById('status').textContent = 'Link copied!';
                }
            };
        }

        // Event listeners
        const video = document.getElementById('video');
        const status = document.getElementById('status');
        video.addEventListener('waiting', () => {
            status.textContent = 'Buffering...';
        });
        video.addEventListener('playing', () => {
            status.textContent = '';
            reportEvent('video_play_start');
        });
        video.addEventListener('error', () => {
            document.getElementById('error').textContent = 'Stream temporarily unavailable â€” try Download.';
            reportEvent('video_error');
        });

        // Load meta on page load
        document.addEventListener('DOMContentLoaded', () => {
            if (!params.id || !params.name || !params.hash) {
                document.getElementById('error').textContent = 'Invalid URL parameters.';
                return;
            }
            fetchMeta();
        });

        reportEvent('page_load');
    </script>
</body>
</html>
